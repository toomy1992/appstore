{
    "$schema": "https://schemas.runtipi.io/v2/dynamic-compose.json",
    "schemaVersion": 2,
    "services": [
        {
            "name": "keycloak",
            "image": "quay.io/keycloak/keycloak:26.5.1",
            "command": [
                "start"
            ],
            "isMain": true,
            "internalPort": 8080,
            "environment": {
                "KC_DB": "postgres",
                "KC_DB_URL": "jdbc:postgresql://${KEYCLOAK_DB_HOST:-keycloak-db}:${KEYCLOAK_DB_PORT:-5432}/${KEYCLOAK_DB_NAME:-keycloak}",
                "KC_DB_USERNAME": "${KEYCLOAK_DB_USERNAME:-keycloak}",
                "KC_DB_PASSWORD": "${KEYCLOAK_DB_PASSWORD}",
                "KC_BOOTSTRAP_ADMIN_USERNAME": "${KEYCLOAK_ADMIN_USERNAME:-admin}",
                "KC_BOOTSTRAP_ADMIN_PASSWORD": "${KEYCLOAK_ADMIN_PASSWORD}",
                "KC_PROXY": "edge",
                "KC_HOSTNAME": "${KEYCLOAK_HOSTNAME:-${APP_DOMAIN}}",
                "TZ": "${TZ:-UTC}"
            },
            "volumes": [
                {
                    "hostPath": "${APP_DATA_DIR}/data",
                    "containerPath": "/opt/keycloak/data"
                }
            ],
            "healthCheck": {
                "test": "curl -f http://localhost:8080/health || exit 1",
                "interval": "30s",
                "timeout": "10s",
                "retries": 3,
                "startPeriod": "60s"
            },
            "dependsOn": [
                "keycloak-db"
            ]
        },
        {
            "name": "keycloak-db",
            "image": "postgres:16-alpine",
            "internalPort": 5432,
            "environment": {
                "POSTGRES_DB": "${KEYCLOAK_DB_NAME:-keycloak}",
                "POSTGRES_USER": "${KEYCLOAK_DB_USERNAME:-keycloak}",
                "POSTGRES_PASSWORD": "${KEYCLOAK_DB_PASSWORD}"
            },
            "volumes": [
                {
                    "hostPath": "${APP_DATA_DIR}/data/postgres",
                    "containerPath": "/var/lib/postgresql/data"
                }
            ]
        }
    ]
}